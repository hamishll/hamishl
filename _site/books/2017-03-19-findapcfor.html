<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>hamishl - findapcfor.me</title>
    <meta name="viewport" content="width=device-width" />
    <link rel="shortcut icon" type="image/png" href="/images/favicon.png" />
    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />

    <!-- Syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css" />

    <!-- Custom CSS  -->
    <link rel="stylesheet" href="/css/main.css" />

    <!-- Responsive CSS -->
    <link rel="stylesheet" href="/css/responsive.css" />

    <!-- Google Fonts -->
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
      href="https://fonts.googleapis.com/css?family=Montserrat:700|Open+Sans:400,600,700"
      rel="stylesheet"
    />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;500;800&display=swap" rel="stylesheet">
    <!-- jQuery and Isotope -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="/scripts/isotope.pkgd.min.js"></script>
    <script src="/scripts/isotope.js"></script>
  </head>
  <body>
      <div class="nav">
        <div class="nav-1 nav-s"><a href="/">Home</a></div>
        <div class="nav-2 nav-s"><a href="/">About</a></div>
        <div class="nav-3 nav-s"><a href="/"><img width="25px" src="/images/logo2021.png"></a></div>
        <div class="nav-4 nav-s"><a href="https://github.com/hamishll">GitHub</a></div>
        <div class="nav-5 nav-s"><a href="https://twitter.com/hamish_leith">Twitter</a></div>
      </div>

      <div class="main">
        <!-- Main Content -->
        <div class="content" id="home">
  <div id="post-info">
    <br /><br />
    <div id="cover-photo-container">
      <!-- 
            <img style="width:100%" id="cover-photo" src="/images/cover_findapcforme.png">
       -->
    </div>
    <div id="info-container">
      <h1 id="title">findapcfor.me</h1>
      <h2 id="author">Hamish</h2>
      <h2 id="date">19 March 2017</h2>
      <!--<span id="date">19 Mar 2017</span>-->
    </div>
  </div>

  <div class="post">
    <h2 id="introduction">Introduction</h2>

<p><a href="http://findapcfor.me">findapcfor.me</a> is a web app for finding available computers at The University of Manchester. It uses AJAX alongside the Google Maps API in order to map…</p>

<p>The university tracks the status of PC clusters in an XML table, hosted <a href="http://www.itservices.manchester.ac.uk/clusteravailability/avail.php">here</a>. Each location is described something like this:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;PLPlace&gt;</span>
   <span class="nt">&lt;name&gt;</span>AGLC Floor -1<span class="nt">&lt;/name&gt;</span>
   <span class="nt">&lt;description</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;open&gt;</span>true<span class="nt">&lt;/open&gt;</span>
   <span class="nt">&lt;latitude&gt;</span>53.464630<span class="nt">&lt;/latitude&gt;</span>
   <span class="nt">&lt;longitude&gt;</span>-2.233479<span class="nt">&lt;/longitude&gt;</span>
   ...
   <span class="nt">&lt;locationCode&gt;</span>010AA<span class="nt">&lt;/locationCode&gt;</span>
   <span class="nt">&lt;locationName&gt;</span>Alan Gilbert Learning Commons<span class="nt">&lt;/locationName&gt;</span>
   <span class="nt">&lt;availability&gt;</span>29 seats taken, 31 seats available<span class="nt">&lt;/availability&gt;</span>
<span class="nt">&lt;/PLPlace&gt;</span></code></pre></figure>

<h2 id="pulling-the-xml-document-ajax">Pulling the XML document (AJAX)</h2>

<p>We’ll use AJAX to request this file. Below is a basic function to achieve this:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">downloadUrl</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span> <span class="p">?</span>
         <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="dl">'</span><span class="s1">Microsoft.XMLHTTP</span><span class="dl">'</span><span class="p">)</span> <span class="p">:</span>
         <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">;</span>
     
    <span class="nx">request</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//request.onreadystatechange = doNothing;</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">status</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
     
    <span class="nx">request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><br /><br />
We can then call each row in the table by refering to the DOM and using the getElementsByTagName method. For example:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// store the elements for each place</span>
<span class="nx">markers</span> <span class="o">=</span> <span class="nx">xml</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">PLPlace</span><span class="dl">"</span><span class="p">);</span>

<span class="c1">// loop through each location (and plot markers)</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">markers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">markers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">innerHTML</span><span class="p">;</span>
	<span class="p">...</span>
	<span class="c1">// rest of the code</span>
<span class="p">}</span></code></pre></figure>

<h2 id="initialising-our-google-map">Initialising our google map</h2>

<p>Let’s create a new map with coordinates centered on University Place:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js">  <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nb">Map</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">map</span><span class="dl">'</span><span class="p">),</span> <span class="p">{</span>
    <span class="na">zoom</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
    <span class="na">center</span><span class="p">:</span> <span class="p">{</span><span class="na">lat</span><span class="p">:</span> <span class="mf">53.469369</span><span class="p">,</span> <span class="na">lng</span><span class="p">:</span> <span class="o">-</span><span class="mf">2.233706</span><span class="p">}</span></code></pre></figure>

<h2 id="styling-markers-based-on-availability">Styling markers based on availability</h2>

<p>What we want to achieve is a gradient that goes from green, to yellow, to red as availability decreases. We’ll set a threshold value of 50, above which markers will simply appear green as there is plenty of space.</p>

<p>Navigating through this colour space isn’t as simple as a linear descent. In RGB values:</p>

<ul>
  <li>Green = 0 , 255 , 0</li>
  <li>Yellow = 255, 255, 0</li>
  <li>Red = 255, 0, 0</li>
</ul>

<p>So first we’ll increase the red values, until we’re halfway below our threshold, and then decrease the green values after this point:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">dangerZone</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">free</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">dangerZone</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">rCol</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
    <span class="nx">gCol</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="mi">200</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">free</span><span class="o">/</span><span class="nx">dangerZone</span><span class="p">));</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">free</span> <span class="o">&lt;</span> <span class="nx">dangerZone</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rCol</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="nx">free</span> <span class="o">-</span> <span class="nx">dangerZone</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nx">dangerZone</span><span class="o">/</span><span class="mi">2</span><span class="p">)));</span>
    <span class="nx">gCol</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">rCol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">gCol</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">markerColor</span> <span class="o">=</span> <span class="nx">rgbToHex</span><span class="p">(</span><span class="nx">rCol</span><span class="p">,</span> <span class="nx">gCol</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p><br />
The rgbToHex function at the end converts this RGB value to a hex (which is the color format used by the google maps API).</p>

<h2 id="determining-marker-size">Determining marker size</h2>

<p>We’ll set the scale of the marker to be a proportion of the max number of computers, which is 182 in the George Begg cluster.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">circle</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">path</span><span class="p">:</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">SymbolPath</span><span class="p">.</span><span class="nx">CIRCLE</span><span class="p">,</span>
  <span class="na">fillColor</span><span class="p">:</span> <span class="nx">markerColor</span><span class="p">,</span>
  <span class="na">fillOpacity</span><span class="p">:</span> <span class="p">.</span><span class="mi">8</span><span class="p">,</span>
  <span class="na">scale</span><span class="p">:</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">30</span><span class="o">*</span><span class="p">(</span><span class="nx">free</span><span class="o">/</span><span class="nx">maxSpaces</span><span class="p">),</span>
  <span class="na">strokeColor</span><span class="p">:</span> <span class="dl">'</span><span class="s1">white</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">strokeWeight</span><span class="p">:</span> <span class="mf">1.5</span>
<span class="p">};</span></code></pre></figure>

<h2 id="getting-coordinates">Getting coordinates</h2>

<figure class="highlight"><pre><code class="language-js" data-lang="js"> <span class="kd">var</span> <span class="nx">point</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLng</span><span class="p">(</span>
    <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">markers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">latitude</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">innerHTML</span><span class="p">)</span> <span class="o">+</span> <span class="nx">deltax</span><span class="p">,</span>
    <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">markers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">longitude</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">innerHTML</span><span class="p">)</span> <span class="o">+</span> <span class="nx">deltay</span><span class="p">);</span></code></pre></figure>

<h2 id="placing-markers-and-infoboxes">Placing markers and infoboxes</h2>

<p>The google maps API have two objects for displaying content - markers and info boxes. We’ll format them as such:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">&lt;div class='infowindow'&gt;&lt;b&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;/b&gt;&lt;br/&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">address</span>  <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;/b&gt;&lt;br/&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">availability</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">&lt;br/&gt;&lt;/div&gt;</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">marker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">Marker</span><span class="p">({</span>
  <span class="na">map</span><span class="p">:</span> <span class="nx">map</span><span class="p">,</span>
  <span class="na">position</span><span class="p">:</span> <span class="nx">point</span><span class="p">,</span>
  <span class="na">icon</span><span class="p">:</span> <span class="nx">circle</span><span class="p">,</span>
  <span class="na">title</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span>
  <span class="na">label</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">text</span><span class="p">:</span> <span class="nx">free</span><span class="p">,</span>
    <span class="na">color</span><span class="p">:</span> <span class="dl">'</span><span class="s1">white</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="c1">// clusters with greater availability have a higher zIndex</span>
  <span class="na">zIndex</span><span class="p">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">free</span><span class="p">),</span>
<span class="p">});</span></code></pre></figure>

<h2 id="pushing-objects-to-the-map">Pushing objects to the map</h2>

<p>We’ll push the markers to the map as such:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">map</span><span class="p">.</span><span class="nx">markers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">marker</span><span class="p">);</span></code></pre></figure>

<p><br />
HTML boxes are a little trickier, as we need to listen for interaction through clicking. We’ll use the following function:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">bindInfoWindow</span><span class="p">(</span><span class="nx">marker</span><span class="p">,</span> <span class="nx">map</span><span class="p">,</span> <span class="nx">infoWindow</span><span class="p">,</span> <span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="nx">marker</span><span class="p">,</span> <span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">infoWindow</span><span class="p">.</span><span class="nx">setContent</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
    <span class="nx">infoWindow</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="nx">marker</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></figure>

<h2 id="conclusion">Conclusion</h2>

<p>Check out the code on GitHub:
<a href="http://github.com/hamishll/findapcfor.me">findapcfor.me on GitHub</a></p>

  </div>
  
  <div class="colophon">
    <p>
      <span id="pub-date">Published on 19 Mar 2017</span> <span class="separator"><!--&bull;--></span>
      <!--<span id="social">Find me on <a href="http://github.com/hamishll">GitHub</a>!</span>-->
    </p>
  </div>
</div>


      </div>
    </div>
    <!-- <script src="/scripts/responsive.js" type="text/javascript"></script> -->
  </body>
</html>
